run-name: "Analyze and index ${{ inputs.repo }}"
on:
  workflow_dispatch:
    inputs:
      repo:
        description: "The repo to build (i.e. Ref12/Codex)."
        required: true
      args:
        description: "Additional arguments to pass"
        required: false
        default: ''
  
jobs:
  index:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: "Setup env"
      shell: pwsh
      run: |
        "CODEX_OUTPUT=${{ runner.temp }}/cdx" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
    - name: "Install Ref12.AutoCodex"
      shell: pwsh
      run: |
        dotnet tool install -g --prerelease Ref12.AutoCodex
    
    - name: "Index ${{ inputs.repo }}"
      shell: pwsh
      run: |
        . autocodex full-index-no-upload `
          -o "${{ env.CODEX_OUTPUT }}" `
          -r "${{ inputs.repo }}" `
          --config-root "${{ github.workspace }}" ${{ inputs.args }}

    - name: Upload analysis artifact
      if: ${{ always() }} 
      uses: actions/upload-artifact@v4
      with:
        name: analysis
        path: ${{ env.CODEX_OUTPUT }}/store

    - name: Upload index artifact
      id: upload-artifact-index
      if: ${{ always() }} 
      uses: actions/upload-artifact@v4
      with:
        name: index
        compression-level: 0 # Needed for paging index artifact directly from artifact storage
        path: ${{ env.CODEX_OUTPUT }}/index

    - name: Upload binlogs artifact
      if: ${{ always() }} 
      uses: actions/upload-artifact@v4
      with:
        name: binlogs
        path: ${{ env.CODEX_OUTPUT }}/binlogs

    - name: Annotate artifact URL (and add clickable link in summary)
      shell: pwsh
      env:
        ARTIFACT_URL: ${{ steps.upload-artifact-index.outputs.artifact-url }}
      run: |
        if (-not $env:ARTIFACT_URL) { Write-Error "artifact-url output missing"; exit 1 }
        # Annotation (not clickable)
        Write-Host "::notice title=Artifact uploaded::URL: $env:ARTIFACT_URL"
        # Clickable link in the job summary
        "ðŸ”— **Artifact:** [$env:ARTIFACT_URL]($env:ARTIFACT_URL)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append          
  
